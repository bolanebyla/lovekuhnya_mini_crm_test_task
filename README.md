# –ú–∏–Ω–∏-CRM

–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ (Senior Python): –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –º–∏–Ω–∏-CRM

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Python 3.13+**
- **[FastAPI](https://fastapi.tiangolo.com/)** - –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API
- **[Uvicorn](https://www.uvicorn.org/)** - ASGI-—Å–µ—Ä–≤–µ—Ä
- **[Dishka](https://github.com/just-work/dishka)** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **[Pydantic](https://docs.pydantic.dev/)** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **[SQLAlchemy](https://www.sqlalchemy.org/)** - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
- **[Alembic](https://alembic.sqlalchemy.org/)** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
- **[UV](https://github.com/astral-sh/uv)** - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ Python

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ª–µ–¥—É—é—â–∏—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤:

- **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏ (–¥–æ–º–µ–Ω–Ω—ã–π, –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π)
- **Dependency Injection**
- **Domain-Driven Design**

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –°–ª–æ–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π (Domain Layer)** - —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ —Å—É—â–Ω–æ—Å—Ç–∏, –Ω–µ
   –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
2. **–°–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Application Layer)** - —Å–æ–¥–µ—Ä–∂–∏—Ç use cases, DTO, —Å–µ—Ä–≤–∏—Å—ã,
   –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ —Ç.–ø.
3. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π (Infrastructure Layer)** - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (
   –ë–î, HTTP API, –∫—ç—à –∏ —Ç.–¥.)

### –û–±—â–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ —Ñ–∞–π–ª–æ–≤
–î–æ–º–µ–Ω–Ω—ã–π –∏ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–ª–æ–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `application` –∏
–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º (bounded contexts):
```
<–∫–æ–º–ø–æ–Ω–µ–Ω—Ç>/
‚îú‚îÄ‚îÄ application/                 # –î–æ–º–µ–Ω–Ω—ã–π –∏ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–ª–æ–∏, –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º
‚îÇ   ‚îú‚îÄ‚îÄ <bounded_context_1>/         
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/            # –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dtos/                # Data Transfer Objects
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interfaces/          # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —Å–µ—Ä–≤–∏—Å—ã)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/    # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (read –∏ write)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ use_cases/           # Use cases (–±–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/            # C–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errors.py            # –û—à–∏–±–∫–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ events.py            # C–æ–±—ã—Ç–∏—è, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ <bounded_context_2>/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ infrastructure/             # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π
    ‚îú‚îÄ‚îÄ database/               # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (SQLAlchemy)
    ‚îú‚îÄ‚îÄ http_api/               # HTTP API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
    ‚îú‚îÄ‚îÄ cache/                  # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    ‚îú‚îÄ‚îÄ events/                 # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    ‚îî‚îÄ‚îÄ ...
```


## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
–ö–∞—Ç–∞–ª–æ–≥ `src/` —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–≤—ã–º –¥–ª—è python –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞,
–Ω–∞–ø—Ä–∏–º–µ—Ä –≤ IDE –º–æ–∂–Ω–æ –µ–≥–æ –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ sources_root
(–≤ —Å–ª—É—á–∞–µ –∑–∞–ø—É—Å–∫–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏, –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `PYTHONPATH` –∏ —Å–æ—Å–ª–∞—Ç—å –Ω–∞ —ç—Ç–æ—Ç
–∫–∞—Ç–∞–ª–æ–≥)

### –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ docker-compose

–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ [docker-compose](../docker-compose) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
—Ñ–∞–π–ª [docker-compose.local.yaml](../docker-compose/docker-compose.local.yaml)
–≤ –∫–æ—Ç–æ—Ä–æ–º —É–∫–∞–∑–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

#### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```shell
cd docker-compose/
```

```shell
docker-compose -f docker-compose.local.yaml -p mini_crm_infrastructure up -d --build 
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é uv:

```bash
uv pip install .
```

2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```
# –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
DB_URL=postgresql+asyncpg://mini_crm:mini_crm@localhost:5432/mini_crm
LOGGING_LEVEL=INFO
LOGGING_JSON=False
```

### üìÉ –ú–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```shell
python -m mini_crm.run.alembic_runner upgrade head
```

`alembic_runner` —ç—Ç–æ –æ–±–µ—Ä—Ç–∫–∞, –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ cli alembic

```shell
python -m mini_crm.run.alembic_runner <other args>
```

### HTTP API

–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ http api

```bash
uvicorn mini_crm.run.http_api:app --reload
```

### Docker

–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞

```shell
docker build -t lovekuhnya_mini_crm_test_task .
```

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```shell
docker run mini_crm:latest entrypoint_migrations.sh
```

–ó–∞–ø—É—Å–∫ http api

```shell
docker run -p 8080:8080 mini_crm:latest entrypoint_http_api.sh
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
pytest
```

## Openapi –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- –§–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:8000/openapi.json
- Swagger –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:8000/docs

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∞–¥—Ä–µ—Å—É `/metrics` (Prometheus)


## üîç –õ–∏–Ω—Ç–µ—Ä—ã

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è [Ruff](https://github.com/astral-sh/ruff)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–∏–Ω—Ç–µ—Ä–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `pyproject.toml` –≤ —Å–µ–∫—Ü–∏–∏ `[tool.ruff]`

### –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–∞

```bash
ruff check .
```

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

```bash
ruff check --fix .
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MyPy

–ó–∞–ø—É—Å–∫ MyPy

```shell
mypy .
```


## üîí Pre-commit

–í –ø—Ä–æ–µ–∫—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω pre-commit –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º.
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ pre-commit –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `.pre-commit-config.yaml`.

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pre-commit

```bash
pre-commit install
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ pre-commit –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∫–æ–º–º–∏—Ç–æ–º.